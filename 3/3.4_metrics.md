# 监控项说明

nomad原生metrics可访问：`http://127.0.0.1:4646/v1/metrics?format=prometheus`

由于nomad plugin并不能访问nomad监控接口，dtle有关的监控需要通过API兼容层访问。

注意：通过兼容层只能看到本节点运行的任务的监控项。

## 配置

首先配置nomad.hcl中打开api兼容层，并配置`publish_metrics = true`。

```
plugin "dtle" {
  config {
    api_addr = "127.0.0.1:8190"
    nomad_addr = "127.0.0.1:4646"
    publish_metrics = true
    stats_collection_interval = 15
    ...
```

访问 `127.0.0.1:8190/metrics` 可查看监控项，或在prometheus中配置从此地址获取监控项。

## 监控项

| 类别  | 监控项 | 
| ------------- | ------------- | 
| 网络流量状态 | - |
| - | network.in_msgs |
| - | network.out_msgs |
| - | network.in_bytes |
| - | network.out_bytes |
| 缓存/队列状态 | - |
| - | buffer.src_queue_size	|
| - | buffer.dest_queue_size |
| - | buffer.send_by_timeout |
| - | buffer.send_by_size_full |
| 内存使用估计 | - |
| --全量 | memory.full_kb |
| --增量 | memory.incr_kb |
| 延迟统计| - |
| - | delay.time |
| 表统计（未实现） | - |
| - | table.insert |
| - | table.update |
| - | table.delete |
| 吞吐统计（未实现） | - |
| - | throughput.num |
| - | throughput.time |

### 关于延迟统计

- 延迟统计仅对增量有效，其原理为：计算binlog中的时间戳和当前时间的差值。
- 需要mysql和dtle主机的时间基本正确。
- 一般取目标端延迟统计值。
  - 若目标端延迟为0，则取源端延迟（即任务卡在传输上的场景）。

### 内存使用

- 内存使用为估计值。
- 根据Go内存分配器原理，job处理完后，内存可能不会立刻被释放给操作系统。
